<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>faces.js editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
      integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l"
      crossorigin="anonymous"
    />
    <style>
      .mb-lots {
        margin-bottom: 3rem;
      }

      #face {
        max-height: 450px;
        max-width: 300px;
      }
      @media (min-width: 762px) {
        #face {
          max-height: unset;
          max-width: unset;
          height: 450px;
          width: 300px;
        }
      }
      @media (min-width: 992px) {
        #face {
          height: 600px;
          width: 400px;
        }
      }

      .group-wrapper {
        padding: 0.5rem;
        background-color: var(--yellow);
        background-image: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.15),
          rgba(255, 255, 255, 0)
        );
        border-radius: 0.3rem;
        margin-bottom: 1rem;
      }

      .group-wrapper-alt {
        background-color: var(--teal);
      }

      .group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .group-header h4 {
        margin-bottom: 0;
      }

      .group-item {
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
      }
      .group-item select {
        margin-right: 0.5rem;
      }

      .group-item-multiline {
        margin-top: 0.5rem;
      }

      .group-item-header {
        margin-bottom: 0.2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .group-item-header label {
        margin-bottom: 0;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="d-md-flex">
        <div class="flex-grow-1">
          <div class="mb-4 mt-2 d-xl-flex">
            <h1>faces.js editor</h1>
            <div class="d-sm-flex align-items-center ml-xl-3">
              <div class="d-flex">
                <select
                  id="option-race"
                  class="form-control mr-3"
                  style="width: 100px"
                >
                  <option value="random">Random</option>
                  <option value="asian">Asian</option>
                  <option value="black">Black</option>
                  <option value="brown">Brown</option>
                  <option value="white">White</option>
                </select>
                <select
                  id="option-gender"
                  class="form-control mr-3"
                  style="width: 80px"
                >
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
              </div>
              <button
                type="button"
                class="btn btn-primary mt-2 mt-sm-0"
                id="randomize"
              >
                Randomize Checked
              </button>
              <div class="ml-sm-3 mt-2 mt-sm-0">
                <button
                  type="button"
                  class="btn btn-secondary btn-sm"
                  id="check-all"
                >
                  All
                </button>
                <button
                  type="button"
                  class="btn btn-secondary btn-sm ml-1"
                  id="check-none"
                >
                  None
                </button>
              </div>
            </div>
          </div>
          <form>
            <div class="row">
              <div class="col-6 col-sm-4 col-md-6 col-lg-4 col-xl-3">
                <div class="group-wrapper">
                  <div class="group-header">
                    <h4>Body</h4>
                    <input
                      class="random-group randomize-body"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-body-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="body-id"></select>
                    <input
                      class="random-attribute randomize-body"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-body-id"
                    />
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="body-color">Skin Color</label>
                      <input
                        class="random-attribute randomize-body"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-body-color"
                      />
                    </div>
                    <input type="color" class="form-control" id="body-color" />
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="body-size">Size</label>
                      <input
                        class="random-attribute randomize-smile-lines"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-body-size"
                      />
                    </div>
                    <input
                      type="range"
                      class="form-control"
                      id="body-size"
                      min=".9"
                      max="1"
                      step="0.01"
                    />
                  </div>
                </div>
                <div class="group-wrapper group-wrapper-alt">
                  <div class="group-header">
                    <h4>Misc Lines</h4>
                    <input
                      class="random-group randomize-misc-lines"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-misc-lines-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="miscLine-id"></select>
                    <input
                      class="random-attribute randomize-misc-lines"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-miscLine-id"
                    />
                  </div>
                </div>
                <div class="group-wrapper">
                  <div class="group-header">
                    <h4>Eye Lines</h4>
                    <input
                      class="random-group randomize-eye-lines"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-eye-lines-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="eyeLine-id"></select>
                    <input
                      class="random-attribute randomize-eye-lines"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-eyeLine-id"
                    />
                  </div>
                </div>
                <div class="group-wrapper group-wrapper-alt">
                  <div class="group-header">
                    <h4>Smile Lines</h4>
                    <input
                      class="random-group randomize-smile-lines"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-smile-lines-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="smileLine-id"></select>
                    <input
                      class="random-attribute randomize-smile-lines"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-smileLine-id"
                    />
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="smileLine-size">Size</label>
                      <input
                        class="random-attribute randomize-smile-lines"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-smileLine-size"
                      />
                    </div>
                    <input
                      type="range"
                      class="form-control"
                      id="smileLine-size"
                      min=".5"
                      max="1.5"
                      step="0.05"
                    />
                  </div>
                </div>
              </div>
              <div class="col-6 col-sm-4 col-md-6 col-lg-4 col-xl-3">
                <div class="group-wrapper group-wrapper-alt">
                  <div class="group-header">
                    <h4>Head</h4>
                    <input
                      class="random-group randomize-head"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-head-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="head-id"></select>
                    <input
                      class="random-attribute randomize-head"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-head"
                    />
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="fatness">Fatness</label>
                      <input
                        class="random-attribute randomize-head"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-fatness"
                      />
                    </div>
                    <input
                      type="range"
                      class="form-control"
                      id="fatness"
                      min="0"
                      max="1"
                      step="0.025"
                    />
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="eyeDistance">Eye Distance</label>
                      <input
                        class="random-attribute"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-eyeDistance"
                      />
                    </div>
                    <input
                      type="range"
                      class="form-control"
                      id="eyeDistance"
                      min="-4"
                      max="4"
                      step="0.5"
                    />
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="shaveOpacity">Shave Darkness</label>
                      <input
                        class="random-attribute"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-shaveOpacity"
                      />
                    </div>
                    <input
                      type="range"
                      class="form-control"
                      id="head-shaveOpacity"
                      min="0"
                      max="0.25"
                      step="0.01"
                    />
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="lineOpacity">Line Visibility</label>
                      <input
                        class="random-attribute randomize-head"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-lineOpacity"
                      />
                    </div>
                    <input
                      type="range"
                      class="form-control"
                      id="lineOpacity"
                      min="0"
                      max="1"
                      step="0.05"
                    />
                  </div>
                </div>
                <div class="group-wrapper">
                  <div class="group-header">
                    <h4>Hair</h4>
                    <input
                      class="random-group randomize-hair"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-hair-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="hair-id"></select>
                    <input
                      class="random-attribute randomize-hair"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-hair-id"
                    />
                  </div>
                  <div class="group-item">
                    <div class="form-check mr-auto">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        value=""
                        checked
                        id="hair-flip"
                      />
                      <label class="form-check-label" for="hair-flip">
                        Flip
                      </label>
                    </div>
                    <div>
                      <input
                        class="random-attribute randomize-hair"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-hair-flip"
                      />
                    </div>
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="hair-color">Color</label>
                      <input
                        class="random-attribute randomize-hair"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-hair-color"
                      />
                    </div>
                    <input type="color" class="form-control" id="hair-color" />
                  </div>
                </div>
                <div class="group-wrapper group-wrapper-alt">
                  <div class="group-header">
                    <h4>Long Hair</h4>
                    <input
                      class="random-group randomize-long-hair"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-long-hair-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="hairBg-id"></select>
                    <input
                      class="random-attribute randomize-long-hair"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-hairBg-id"
                    />
                  </div>
                </div>
                <div class="group-wrapper">
                  <div class="group-header">
                    <h4>Facial Hair</h4>
                    <input
                      class="random-group randomize-facial-hair"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-facial-hair-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="facialHair-id"></select>
                    <input
                      class="random-attribute randomize-facial-hair"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-facialHair-id"
                    />
                  </div>
                </div>
              </div>
              <div class="col-6 col-sm-4 col-md-6 col-lg-4 col-xl-3">
                <div class="group-wrapper">
                  <div class="group-header">
                    <h4>Eyebrows</h4>
                    <input
                      class="random-group randomize-eyebrows"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-eyebrows-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="eyebrow-id"></select>
                    <input
                      class="random-attribute randomize-eyebrows"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-eyebrow-id"
                    />
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="eyebrow-angle">Angle</label>
                      <input
                        class="random-attribute randomize-eyebrows"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-eyebrow-angle"
                      />
                    </div>
                    <input
                      type="range"
                      class="form-control"
                      id="eyebrow-angle"
                      min="-15"
                      max="20"
                      step="1"
                    />
                  </div>
                </div>
                <div class="group-wrapper group-wrapper-alt">
                  <div class="group-header">
                    <h4>Eyes</h4>
                    <input
                      class="random-group randomize-eyes"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-eyes-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="eye-id"></select>
                    <input
                      class="random-attribute randomize-eyes"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-eye-id"
                    />
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="eye-angle">Angle</label>
                      <input
                        class="random-attribute randomize-eyes"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-eye-angle"
                      />
                    </div>
                    <input
                      type="range"
                      class="form-control"
                      id="eye-angle"
                      min="-15"
                      max="20"
                      step="1"
                    />
                  </div>
                </div>
                <div class="group-wrapper">
                  <div class="group-header">
                    <h4>Nose</h4>
                    <input
                      class="random-group randomize-nose"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-nose-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="nose-id"></select>
                    <input
                      class="random-attribute randomize-nose"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-nose-id"
                    />
                  </div>
                  <div class="group-item">
                    <div class="form-check mr-auto">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        value=""
                        checked
                        id="nose-flip"
                      />
                      <label class="form-check-label" for="nose-flip">
                        Flip
                      </label>
                    </div>
                    <div>
                      <input
                        class="random-attribute randomize-nose"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-nose-flip"
                      />
                    </div>
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="nose-size">Size</label>
                      <input
                        class="random-attribute randomize-nose"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-nose-size"
                      />
                    </div>
                    <input
                      type="range"
                      class="form-control"
                      id="nose-size"
                      min=".5"
                      max="1.25"
                      step="0.025"
                    />
                  </div>
                </div>
                <div class="group-wrapper group-wrapper-alt">
                  <div class="group-header">
                    <h4>Mouth</h4>
                    <input
                      class="random-group randomize-mouth"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-mouth-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="mouth-id"></select>
                    <input
                      class="random-attribute randomize-mouth"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-mouth-id"
                    />
                  </div>
                  <div class="group-item">
                    <div class="form-check mr-auto">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        value=""
                        checked
                        id="mouth-flip"
                      />
                      <label class="form-check-label" for="hair-flip">
                        Flip
                      </label>
                    </div>
                    <div>
                      <input
                        class="random-attribute randomize-mouth"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-mouth-flip"
                      />
                    </div>
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="mouth-size">Size</label>
                      <input
                        class="random-attribute randomize-mouth"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-mouth-size"
                      />
                    </div>
                    <input
                      type="range"
                      class="form-control"
                      id="mouth-size"
                      min="0.7"
                      max="1.3"
                      step="0.02"
                    />
                  </div>
                </div>
              </div>
              <div class="col-6 col-sm-4 col-md-6 col-lg-4 col-xl-3">
                <div class="group-wrapper group-wrapper-alt">
                  <div class="group-header">
                    <h4>Ears</h4>
                    <input
                      class="random-group randomize-ears"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-ears-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="ear-id"></select>
                    <input
                      class="random-attribute randomize-ears"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-ear-id"
                    />
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="ear-size">Size</label>
                      <input
                        class="random-attribute randomize-ears"
                        type="checkbox"
                        value=""
                        checked
                        id="randomize-ear-size"
                      />
                    </div>
                    <input
                      type="range"
                      class="form-control"
                      id="ear-size"
                      min="0.5"
                      max="1.5"
                      step="0.02"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="earring-id"></select>
                    <input
                      class="random-attribute randomize-ears"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-earring-id"
                    />
                  </div>
                </div>
                <div class="group-wrapper">
                  <div class="group-header">
                    <h4>Accessories</h4>
                    <input
                      class="random-group randomize-accessories"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-accessories-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="accessories-id"></select>
                    <input
                      class="random-attribute randomize-accessories"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-accessories-id"
                    />
                  </div>
                </div>
                <div class="group-wrapper group-wrapper-alt">
                  <div class="group-header">
                    <h4>Glasses</h4>
                    <input
                      class="random-group randomize-glasses"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-glasses-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="glasses-id"></select>
                    <input
                      class="random-attribute randomize-glasses"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-glasses-id"
                    />
                  </div>
                </div>
                <div class="group-wrapper">
                  <div class="group-header">
                    <h4>Jersey</h4>
                    <input
                      class="random-group randomize-jersey"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-jersey-group"
                    />
                  </div>
                  <div class="group-item">
                    <select class="form-control" id="jersey-id"></select>
                    <input
                      class="random-attribute randomize-jersey"
                      type="checkbox"
                      value=""
                      checked
                      id="randomize-jersey-id"
                    />
                  </div>
                </div>
                <div class="group-wrapper group-wrapper-alt">
                  <h4>Team Colors</h4>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="body-color">Primary</label>
                    </div>
                    <input
                      type="color"
                      class="form-control"
                      id="teamColors-0"
                    />
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="body-color">Secondary</label>
                    </div>
                    <input
                      type="color"
                      class="form-control"
                      id="teamColors-1"
                    />
                  </div>
                  <div class="group-item-multiline">
                    <div class="group-item-header">
                      <label for="body-color">Accent</label>
                    </div>
                    <input
                      type="color"
                      class="form-control"
                      id="teamColors-2"
                    />
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="ml-md-3">
          <div id="face"></div>
          <div id="face2"></div>
          <textarea id="json" class="form-control mt-3"></textarea>
          <button class="btn btn-secondary mt-1" id="copy">
            Copy to clipboard
          </button>
          <button class="btn btn-secondary mt-1" id="paste">Draw JSON</button>
          <button class="btn btn-secondary mt-1" id="reset">
            Reset from drawing
          </button>
        </div>
      </div>
    </div>
  </body>
  <script src="build/bundle.js"></script>
  <script>
    const faceWrapper = document.getElementById("face");
    const jsonElement = document.getElementById("json");

    let face;

    document.getElementById("copy").addEventListener("click", () => {
      jsonElement.focus();
      jsonElement.select();

      const successful = document.execCommand("copy");
      const msg = successful ? "successful" : "unsuccessful";
      console.log("Copying text command was " + msg);
    });

    document.getElementById("paste").addEventListener("click", () => {
      let json_val = jsonElement.value;

      try {
        const parsedJson = JSON.parse(json_val);
        faces.override(face, parsedJson);
        updateDisplay();

        // Update all dropdowns in the form to what the user entered
        initializeFormValues();
      } catch (error) {
        console.error(error);
        alert("Invalid JSON input");
      }
    });

    document.getElementById("reset").addEventListener("click", () => {
      jsonElement.value = JSON.stringify(face);
    });

    const generateFace = () => {
      const options = {
        gender: document.getElementById("option-gender").value,
        race: document.getElementById("option-race").value,
      };
      if (options.race === "random") {
        delete options.race;
      }
      return faces.generate(undefined, options);
    };

    if (location.hash.length <= 1) {
      face = generateFace();
    } else {
      try {
        face = JSON.parse(atob(location.hash.slice(1)));
      } catch (error) {
        console.error(error);
        face = generateFace();
      }
    }

    const randomizeFace = (oldFace, newFace) => {
      Array.from(document.getElementsByClassName("random-attribute")).forEach(
        (elem) => {
          if (!elem.checked) {
            const parts = elem.id.split("-").slice(1);
            if (parts.length === 1) newFace[parts[0]] = oldFace[parts[0]];
            else if (!isNaN(parseInt(parts[1]))) {
              const idx = parseInt(parts[1]);
              newFace[parts[0]][idx] = oldFace[parts[0]][idx];
            } else if (parts.length === 2)
              newFace[parts[0]][parts[1]] = oldFace[parts[0]][parts[1]];
          }
        }
      );
      return newFace;
    };

    const updateDisplay = () => {
      console.log(face);

      let server_or_dom = "server";

      if (server_or_dom === "server") {
        faceWrapper.innerHTML = faces.buildSVGString(face);
      } else {
        faces.display(faceWrapper, face);
      }

      history.replaceState(
        undefined,
        undefined,
        `#${btoa(JSON.stringify(face))}`
      );
      jsonElement.value = JSON.stringify(face);
    };

    const initializeSelectOptions = () => {
      for (const feature of Object.keys(faces.svgsIndex)) {
        const options = faces.svgsIndex[feature];
        const selectElement = document.getElementById(`${feature}-id`);
        for (const option of options) {
          const optionElement = document.createElement("option");
          optionElement.value = option;
          optionElement.text = option;
          selectElement.add(optionElement, null);
        }
      }
    };

    const isValue = (obj) =>
      typeof obj === "boolean" ||
      typeof obj === "number" ||
      typeof obj === "string";

    const initializeFormValue = (id, value) => {
      const element = document.getElementById(id);
      if (id == "innerHTML") {
        return;
      }

      if (element.classList.contains("form-check-input")) {
        element.checked = value;
      } else {
        element.value = value;

        if (
          element.type == "select-one" &&
          !isValidDropdownOption(element, value)
        ) {
          alert(`Invalid option ${value} for ${id}`);
        } else if (element.type == "number" && !isValidNumberValue(value)) {
          alert(`Invalid value ${value} for ${id}. Must be number.`);
        }
      }
    };

    const isValidDropdownOption = (element, value) => {
      for (const option of element.childNodes) {
        if (option.value === value) {
          return true;
        }
      }
      return false;
    };

    const isValidNumberValue = (value) => {
      return !isNaN(parseFloat(value));
    };

    const initializeFormValues = () => {
      for (const key of Object.keys(face)) {
        if (isValue(face[key])) {
          initializeFormValue(key, face[key]);
        } else {
          for (const key2 of Object.keys(face[key])) {
            if (isValue(face[key][key2])) {
              initializeFormValue(`${key}-${key2}`, face[key][key2]);
            } else {
              throw new Error(`wtf is in face.${key}.${key2}`);
            }
          }
        }
      }
    };

    const getValue = (oldValue, event) => {
      if (typeof oldValue === "number") {
        return parseFloat(event.target.value);
      }
      if (typeof oldValue === "boolean") {
        return event.target.checked;
      }
      return event.target.value;
    };
    const listenForChanges = () => {
      const textInputs = document.querySelectorAll("input.form-control");
      const checkboxInputs = document.querySelectorAll(
        "input.form-check-input"
      );
      const selects = document.querySelectorAll("select.form-control");

      for (const input of [...textInputs, ...checkboxInputs, ...selects]) {
        if (
          input.id.startsWith("randomize") ||
          input.id.startsWith("option-")
        ) {
          continue;
        }
        input.addEventListener("change", (event) => {
          const parts = event.target.id.split("-");

          if (parts.length === 1) {
            face[parts[0]] = getValue(face[parts[0]], event);
          } else if (parts.length === 2) {
            face[parts[0]][parts[1]] = getValue(
              face[parts[0]][parts[1]],
              event
            );
          } else {
            throw new Error(`Invalid ID ${event.target.id}`);
          }

          updateDisplay();
        });
      }

      document.getElementById("randomize").addEventListener("click", () => {
        const oldFace = face;
        face = randomizeFace(oldFace, generateFace());
        initializeFormValues();
        updateDisplay();
      });

      const checkboxes = [].concat(
        Array.from(document.getElementsByClassName("random-group")),
        Array.from(document.getElementsByClassName("random-attribute"))
      );
      document.getElementById("check-all").addEventListener("click", () => {
        for (const checkbox of checkboxes) {
          checkbox.checked = true;
        }
      });

      document.getElementById("check-none").addEventListener("click", () => {
        for (const checkbox of checkboxes) {
          checkbox.checked = false;
        }
      });

      Array.from(document.getElementsByClassName("random-group")).forEach(
        (elem) => {
          elem.addEventListener("click", () => {
            Array.from(
              document.getElementsByClassName(elem.id.replace("-group", ""))
            ).forEach((elem2) => (elem2.checked = elem.checked));
          });
        }
      );

      Array.from(document.getElementsByClassName("random-attribute")).forEach(
        (elem) => {
          elem.addEventListener("click", () => {
            Array.from(elem.className.split(" ")).forEach((className) => {
              if (className.startsWith("randomize-")) {
                if (elem.checked) {
                  // See if all are checked, and if so check the group
                  const others = Array.from(
                    document.getElementsByClassName(className)
                  ).filter(
                    (other) => !other.classList.contains("random-group")
                  );
                  if (others.every((other) => other.checked)) {
                    document.getElementById(
                      className + "-group"
                    ).checked = true;
                  }
                } else {
                  document.getElementById(className + "-group").checked = false;
                }
              }
            });
          });
        }
      );
    };

    updateDisplay();
    initializeSelectOptions();
    initializeFormValues();
    listenForChanges();

    // Reload when something changes
    const socket = new WebSocket("ws://localhost:3001/");
    socket.addEventListener("message", (event) => {
      if (event.data === "reload") {
        location.reload();
      }
    });
  </script>
</html>
